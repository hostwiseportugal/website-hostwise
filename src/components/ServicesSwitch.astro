---
import OptimizedImage from './OptimizedImage.astro';
import type { ImageMetadata } from 'astro';
import { property1, property2, heroDefault } from '../lib/fallback-images';

interface WPImage {
  url?: string;
  alt?: string;
  source_url?: string;
}

interface ServiceItem {
  key?: string;
  switch_label?: string; // texto do botão de navegação
  label?: string;        // etiqueta em cima do H2
  title?: string;
  description?: string;
  cta_label?: string;
  cta_url?: string;
  badge_number?: string;
  badge_text?: string;
  image?: WPImage | ImageMetadata | string;
}

interface ServicesSwitchProps {
  services?: ServiceItem[];
}

// normalize image
function normalizeImage(
  img: WPImage | ImageMetadata | string | undefined,
  fallback: ImageMetadata,
  fallbackAlt: string
): { src: ImageMetadata | string; alt: string } {
  if (!img) return { src: fallback, alt: fallbackAlt };

  // ImageMetadata (imported local image)
  if (typeof img === 'object' && 'src' in img && 'width' in img) {
    return { src: img as ImageMetadata, alt: fallbackAlt };
  }

  if (typeof img === 'string') {
    return { src: img || fallback, alt: fallbackAlt };
  }

  // WPImage
  return {
    src: img.url || img.source_url || fallback,
    alt: img.alt || fallbackAlt,
  };
}

const { services = [] } = Astro.props as ServicesSwitchProps;

// FALLBACK SERVICES
const defaultServices: ServiceItem[] = services.length
  ? services
  : [
      {
        key: 'alojamento-local',
        switch_label: 'Proprietário de Imóvel',
        label: 'Gestão de Alojamento Local',
        title: 'Maximize o Rendimento Sem Preocupações',
        description:
          'Maximize o potencial do seu alojamento local com uma gestão 100% dedicada. Presença nas principais plataformas e serviço de excelência.',
        cta_label: 'Saber Mais',
        cta_url: '/gestao-alojamento-local',
        badge_number: '+40%',
        badge_text: 'Rentabilidade Média',
        image: heroDefault,
      },
      {
        key: 'gestao-edificios',
        switch_label: 'Proprietário de Edifício',
        label: 'Gestão de Edifícios Multi-Unit',
        title: 'Transforme o seu edifício num ativo hoteleiro de performance',
        description:
          'Transforme o seu ativo num aparthotel profissional com gestão hoteleira verdadeira. Gerimos edifícios inteiros (5-30 unidades) com operação end-to-end.',
        cta_label: 'Saber Mais',
        cta_url: '/gestao-predios-multi-unit',
        badge_number: '+15%',
        badge_text: 'Valuation Increase',
        image: property1,
      },
      {
        key: 'asset-management',
        switch_label: 'Gestor de Portfólio',
        label: 'Gestão Hoteleira e Asset Management',
        title:
          'Otimização de performance e valuation para portfolios de hospitalidade',
        description:
          'Partnership de asset management para boutique hotels, aparthotéis, hostels, e portfolios multi-propriedade. Combinamos expertise hoteleira com rigor de gestão de ativos imobiliários.',
        cta_label: 'Saber Mais',
        cta_url: '/gestao-hoteleira-asset-management',
        badge_number: '+15%',
        badge_text: 'Net Operating Income',
        image: property2,
      },
    ];
---

<section class="services-section">
  <div class="container">

    <!-- NAV -->
    <nav class="services-switch-nav">
      <div class="switch-container">
        <div class="switch-background" id="switchBackground"></div>

        {defaultServices.map((service, index) => (
          <button
            class={`switch-btn ${index === 0 ? 'active' : ''}`}
            data-target={service.key}
          >
            {service.key === 'alojamento-local' && (
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
              </svg>
            )}

            {service.key === 'gestao-edificios' && (
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z" />
              </svg>
            )}

            {service.key === 'asset-management' && (
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                <path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V6H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z" />
              </svg>
            )}

            <span>{service.switch_label || service.label}</span>
          </button>
        ))}
      </div>
    </nav>

    <!-- CONTENT -->
    <div class="services-content">
      {defaultServices.map((service) => {
        const img = normalizeImage(
          service.image,
          property1,
          service.title || 'Host Wise Service'
        );

        return (
          <div class="service-item" id={service.key}>
            <div class={`service-layout ${service.key === 'gestao-edificios' ? 'service-layout--reverse' : ''}`}>
              <div class="service-text">
                <h2 class="service-label">{service.label}</h2>

                <h3>{service.title}</h3>

                <p>{service.description}</p>

                {service.cta_label && (
                  <a href={service.cta_url} class="btn-cta">
                    {service.cta_label}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                      <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
                    </svg>
                  </a>
                )}
              </div>

              <div class="service-visual">
                <OptimizedImage src={img.src} alt={img.alt} loading="lazy" />

                {(service.badge_number || service.badge_text) && (
                  <div class="visual-badge">
                    <span class="badge-number">{service.badge_number}</span>
                    <span class="badge-text">{service.badge_text}</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>

  </div>
</section>



<style>
  .services-section {
    padding: 80px 20px;
    background: white;
    position: relative;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Sticky Switch Navigation */
  .services-switch-nav {
    position: sticky;
    top: 100px;
    z-index: 10;
    display: flex;
    justify-content: center;
    margin-bottom: 80px;
  }

  .switch-container {
    position: relative;
    display: flex;
    gap: 8px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 8px;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    border: 2px solid var(--gray-light);
  }

  .switch-background {
    position: absolute;
    top: 8px;
    left: 8px;
    height: calc(100% - 16px);
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    border-radius: 12px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 12px rgba(12, 68, 99, 0.2);
  }

  .switch-btn {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 14px 24px;
    border: none;
    background: transparent;
    color: var(--text);
    font-weight: 600;
    font-size: 0.95rem;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
  }

  .switch-btn svg {
    transition: transform 0.3s;
  }

  .switch-btn.active {
    color: white;
  }

  .switch-btn.active svg {
    transform: scale(1.1);
  }

  .switch-btn:not(.active):hover {
    background: var(--blue-light);
    color: var(--primary);
  }

  /* Services Content */
  .services-content {
    display: flex;
    flex-direction: column;
    gap: 120px;
  }

  /* Service Item */
  .service-item {
    scroll-margin-top: 200px;
  }

  /* Service Layout */
  .service-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 80px;
    align-items: center;
  }

  .service-layout--reverse {
    direction: rtl;
  }

  .service-layout--reverse > * {
    direction: ltr;
  }

  /* Service Text */
  .service-text {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .service-label {
    display: inline-block;
    width: fit-content;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 10px 24px;
    border-radius: 30px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 12px rgba(12, 68, 99, 0.15);
  }

  .service-text h3 {
    font-size: 2.5rem;
    color: var(--primary);
    line-height: 1.2;
    margin: 0;
  }

  .service-text p {
    font-size: 1.15rem;
    line-height: 1.7;
    color: var(--text);
    opacity: 0.9;
    margin: 0;
  }

  /* CTA Button - Coral/Laranja */
  .btn-cta {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    width: fit-content;
    padding: 16px 32px;
    background: transparent;
    border: 2px solid #FF6B35;
    color: #FF6B35;
    font-weight: 600;
    font-size: 1.05rem;
    border-radius: 12px;
    text-decoration: none;
    transition: all 0.3s;
  }

  .btn-cta:hover {
    transform: translateY(-2px);
    background: #FF6B35;
    color: white;
    box-shadow: 0 4px 20px rgba(255, 107, 53, 0.25);
    gap: 14px;
  }

  .btn-cta svg {
    transition: transform 0.3s;
  }

  .btn-cta:hover svg {
    transform: translateX(4px);
  }

  /* Service Visual */
  .service-visual {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    aspect-ratio: 4/3;
  }

  .service-visual {
  position: relative;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
  aspect-ratio: 4/3;
}

/* Astro <Image /> costuma gerar <picture> */
.service-visual :global(picture) {
  display: block;
  width: 100%;
  height: 100%;
}

/* e o <img> lá dentro */
.service-visual :global(img) {
  display: block;
  width: 100%;
  height: 100%;
  object-fit: cover;
}


  .visual-badge {
    position: absolute;
    bottom: 30px;
    right: 30px;
    background: white;
    padding: 20px 28px;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    text-align: center;
  }

  .badge-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
    margin-bottom: 6px;
  }

  .badge-text {
    display: block;
    font-size: 0.85rem;
    color: var(--text);
    font-weight: 600;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .services-section {
      padding: 60px 20px;
    }

    .services-switch-nav {
      top: 80px;
      margin-bottom: 60px;
    }

    .services-content {
      gap: 80px;
    }

    .service-layout,
    .service-layout--reverse {
      grid-template-columns: 1fr;
      gap: 50px;
      direction: ltr;
    }

    .service-text h3 {
      font-size: 2rem;
    }
  }

  @media (max-width: 768px) {
    .services-section {
      padding: 60px 20px 40px;
    }

    .services-switch-nav {
      margin-bottom: 40px;
    }

    .switch-container {
      flex-direction: column;
      width: 100%;
      max-width: 500px;
      gap: 8px;
    }

    .switch-background {
      display: none;
    }

    .switch-btn {
      width: 100%;
      justify-content: flex-start;
      padding: 16px 20px;
      background: white;
      border: 2px solid var(--gray-light);
      color: var(--text);
    }

    .switch-btn.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-color: var(--secondary);
      color: white;
    }

    .switch-btn.active svg {
      color: white;
    }

    .switch-btn:not(.active) svg {
      color: var(--primary);
    }

    .services-content {
      gap: 60px;
    }

    .service-layout {
      gap: 40px;
    }

    .service-text h3 {
      font-size: 1.75rem;
    }

    .service-text p {
      font-size: 1rem;
    }

    .btn-cta {
      padding: 14px 28px;
      font-size: 1rem;
    }

    .visual-badge {
      bottom: 20px;
      right: 20px;
      padding: 16px 20px;
    }

    .badge-number {
      font-size: 1.5rem;
    }

    .badge-text {
      font-size: 0.8rem;
    }
  }

  @media (max-width: 480px) {
    .services-section {
      padding: 60px 16px 40px;
    }

    .switch-container {
      padding: 6px;
    }

    .switch-btn {
      padding: 14px 16px;
      font-size: 0.9rem;
    }

    .service-text h3 {
      font-size: 1.5rem;
    }

    .btn-cta {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<script>
  class ServicesSwitch {
    private buttons: NodeListOf<HTMLElement>;
    private background: HTMLElement;
    private observer: IntersectionObserver | null = null;

    constructor() {
      this.buttons = document.querySelectorAll('.switch-btn');
      this.background = document.getElementById('switchBackground')!;

      this.init();
    }

    init() {
      // Set initial background position
      const activeBtn = document.querySelector('.switch-btn.active') as HTMLElement;
      if (activeBtn) {
        this.updateBackground(activeBtn);
      }

      // Add click handlers for smooth scroll
      this.buttons.forEach(btn => {
        btn.addEventListener('click', () => this.handleClick(btn));
      });

      // Intersection Observer to update active state on scroll
      this.setupIntersectionObserver();

      // Update background on resize
      window.addEventListener('resize', () => {
        const activeBtn = document.querySelector('.switch-btn.active') as HTMLElement;
        if (activeBtn) {
          this.updateBackground(activeBtn);
        }
      });
    }

    handleClick(btn: HTMLElement) {
      const targetId = btn.dataset.target;
      if (!targetId) return;

      const targetEl = document.getElementById(targetId);
      if (!targetEl) return;

      // Smooth scroll to target
      targetEl.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      });

      // Update active state
      this.updateActiveButton(btn);
    }

    setupIntersectionObserver() {
      const options = {
        root: null,
        rootMargin: '-50% 0px -50% 0px',
        threshold: 0
      };

      this.observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const targetId = entry.target.id;
            const correspondingBtn = document.querySelector(`[data-target="${targetId}"]`) as HTMLElement;
            if (correspondingBtn) {
              this.updateActiveButton(correspondingBtn);
            }
          }
        });
      }, options);

      // Observe all service items
      document.querySelectorAll('.service-item').forEach(item => {
        this.observer?.observe(item);
      });
    }

    updateActiveButton(btn: HTMLElement) {
      this.buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      this.updateBackground(btn);
    }

    updateBackground(btn: HTMLElement) {
      const offsetLeft = btn.offsetLeft;
      const width = btn.offsetWidth;

      this.background.style.left = `${offsetLeft}px`;
      this.background.style.width = `${width}px`;
    }
  }

  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      new ServicesSwitch();
    });
  }
</script>